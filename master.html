<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Svenska Ã–vning - Master Portal</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link rel="stylesheet" href="global/style/style.css?v=1">
    <link rel="icon" type="image/x-icon" href="global/style/favicon/favicon.ico">
</head>

<body>
    <header class="main-header">
        <h1>
            <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 10px;">
                <img src="global/style/images/NK_Avatar.png" alt="Logo" class="header-logo">
                Grammatik Portal ğŸ‡¸ğŸ‡ª
            </a>
        </h1>

        <div class="lang-selector-container">
            <button class="lang-selected-btn" onclick="toggleLangDropdown()">
                <span id="current-flag">ğŸ‡¸ğŸ‡ª</span> <span id="current-lang-code">SV</span>
            </button>
            <ul id="lang-dropdown" class="lang-dropdown">
                <li onclick="changeLanguage('sv', 'ğŸ‡¸ğŸ‡ª')">ğŸ‡¸ğŸ‡ª SV (Svenska)</li>
                <li onclick="changeLanguage('en', 'ğŸ‡¬ğŸ‡§')">ğŸ‡¬ğŸ‡§ EN (English)</li>
                <li onclick="changeLanguage('th', 'ğŸ‡¹ğŸ‡­')">ğŸ‡¹ğŸ‡­ TH (à¹„à¸—à¸¢)</li>
            </ul>
        </div>
    </header>

    <div class="layout">
        <nav class="sidebar">
            <ul id="shared-sidebar"></ul>
        </nav>

        <main class="content">
            <section class="practice-area">
                <div class="section-header">
                    <h2 id="dynamic-title">Laddar Ã¶vning...</h2>
                    <a id="back-button" href="javascript:void(0);" onclick="history.back()" class="back-btn">â¬… Tillbaka</a>
                </div>

                <div id="loading-indicator" style="text-align: center; padding: 50px;">
                    SÃ¶ker i Google Sheets...
                </div>

                <div id="dynamic-content"></div>

                <div id="table-view" style="display: none;">
                    <div class="top-controls">
                        <div class="left-actions">
                            <button id="restart-btn" onclick="engine.clearAll()">ğŸ”„ Slumpa om</button>
                            <div class="filter-controls">
                                <button id="save-filter-btn" onclick="engine.saveSelection()" style="display:none;">Spara</button>
                                <button id="cancel-filter-btn" onclick="location.reload()" style="display:none;">Avbryt</button>
                            </div>
                        </div>
                        <div class="right-actions">
                            <button id="filter-btn" onclick="engine.enterSelectionMode()">âš™ï¸ Setting</button>
                        </div>
                    </div>
                    
                    <table class="practice-table">
                        <thead>
                            <tr id="table-headers"></tr>
                        </thead>
                        <tbody id="practice-rows"></tbody>
                    </table>
                </div>

                <div id="cloze-view" style="display: none;">
                    <div class="top-controls">
                        <div class="left-actions">
                            <button onclick="clozeEngine.clearAll()">ğŸ”„ Slumpa om</button>
                        </div>
                        <div class="right-actions">
                            <button onclick="clozeEngine.enterSelectionMode()">âš™ï¸ Setting</button>
                        </div>
                    </div>
                    <div id="exercise-container" class="exercise-container"></div>
                </div>

                <div id="pagination" class="controls" style="display: none; gap: 10px; margin-top: 20px;">
                    <button id="prev-set-btn" onclick="engine.loadPreviousSet ? engine.loadPreviousSet() : clozeEngine.loadPreviousSet()">â¬… FÃ¶regÃ¥ende</button>
                    <button id="next-set-btn" onclick="engine.loadNextSet ? engine.loadNextSet() : clozeEngine.loadNextSet()">NÃ¤sta</button>
                </div>
            </section>
        </main>
    </div>

    <script src="global/engine/table_engine.js"></script>
    <script src="global/engine/cloze_engine.js"></script>
    <script src="global/engine/dashboard_engine.js"></script>

    <script>
        // --- SECURE OBFUSCATED ROUTING ---
        const _idMap = {
            'other': 'AKfycbxXh_MXiFgt695vfhAHkbMMIbM4wdPI9jF1mmtH2u1JvJbmRVK1fCUk7DuMkjhscjNJ',
            'gmmr':  'AKfycb_YOUR_GRAMMAR_ID_HERE',
            'dict':  'AKfycb_YOUR_DICTATION_ID_HERE'
        };

        const table_Config = {
            primaryKey: 'singularOb',
            columns: [
                { key: 'article',    type: 'input_hint', placeholder: 'en/ett/-' },
                { key: 'singularOb', type: 'hint' },
                { key: 'singularBe', type: 'input' },
                { key: 'pluralOb',   type: 'input' },
                { key: 'pluralBe',   type: 'input' },
                { key: 'group',      type: 'group' },
                { key: null,         type: 'control' },
                { key: 'translation',type: 'translation' }
            ]
        };

        function toggleLangDropdown() {
            document.getElementById('lang-dropdown').classList.toggle('show');
        }

        function changeLanguage(langCode, flag) {
            localStorage.setItem('userPreferredLang', langCode);
            localStorage.setItem('userPreferredFlag', flag);
            location.reload(); 
        }

        function initLanguageUI() {
            const savedLang = localStorage.getItem('userPreferredLang') || 'sv';
            const savedFlag = localStorage.getItem('userPreferredFlag') || 'ğŸ‡¸ğŸ‡ª';
            document.getElementById('current-lang-code').innerText = savedLang.toUpperCase();
            document.getElementById('current-flag').innerText = savedFlag;
        }

        async function loadSidebar() {
            try {
                const response = await fetch('global/sidebar.html');
                const text = await response.text();
                const sidebarUl = document.getElementById('shared-sidebar');
                sidebarUl.innerHTML = text;
                const params = new URLSearchParams(window.location.search);
                const category = params.get('category'); 
                if (category) {
                    const activeLink = sidebarUl.querySelector(`[data-nav$="${category}"]`);
                    if (activeLink) activeLink.classList.add('active');
                }
            } catch (error) { console.error("Sidebar Failed:", error); }
        }

        async function initMasterApp() {
            initLanguageUI(); 
            await loadSidebar();

            const params = new URLSearchParams(window.location.search);
            
            // --- FIX 1: Align default category with GS tab name "other_index"
            let category = params.get('category') || 'other_index';
            if (category === 'index') category = 'other_index'; // Safety bridge

            const type     = params.get('type')     || 'dashboard';
            const level    = params.get('level')    || 'a1a2';
            const theme    = params.get('theme')    || 'All';
            const userLang = localStorage.getItem('userPreferredLang') || 'sv';

            // --- FIX 2: Correct routing prefix logic
            const prefix = category.split('_')[0]; 
            const targetId = _idMap[prefix] || _idMap['other'];
            const ACTIVE_DB_URL = `https://script.google.com/macros/s/${targetId}/exec`;

            // --- FIX 3: Dynamic Tab Name Construction
            const sheetName = (prefix === 'gmmr' || prefix === 'dict') 
                ? `${category}_${level}_${theme}` 
                : category;

            const loadingIndicator = document.getElementById('loading-indicator');
            const dynamicContent = document.getElementById('dynamic-content');
            
            try {
                // Testing output for debugging
                console.log("Fetching from:", ACTIVE_DB_URL, "for sheet:", sheetName);

                const response = await fetch(`${ACTIVE_DB_URL}?sheet=${sheetName}`);
                const data = await response.json();

                if (!Array.isArray(data)) throw new Error(`Fliken hittades inte: ${sheetName}`);

                let dashboardRows = [];
                let collectingDashboard = false;
                let currentDashboardLogic = '';

                data.forEach(row => {
                    const typeAttr = row.Type ? row.Type.toLowerCase() : '';
                    const keyAttr = row['Content/Key'] || '';
                    
                    let langCol = 'Data 1'; 
                    if (userLang === 'en') langCol = 'Data 2';
                    if (userLang === 'th') langCol = 'Data 3';
                    const contentText = row[langCol] || row['Data 1'];

                    if (typeAttr === 'dashboard_start') {
                        collectingDashboard = true;
                        currentDashboardLogic = row.Logic;
                        dashboardRows = []; 
                        return;
                    }
                    if (collectingDashboard && typeAttr === 'card') {
                        dashboardRows.push(row);
                        return;
                    }
                    if (typeAttr === 'dashboard_end' && collectingDashboard) {
                        collectingDashboard = false;
                        const dashId = `dash-${Math.random().toString(36).substr(2, 9)}`;
                        const dashDiv = document.createElement('div');
                        dashDiv.id = dashId;
                        dynamicContent.appendChild(dashDiv);
                        dashboardEngine.init(dashId, dashboardRows, currentDashboardLogic);
                        return;
                    }

                    if (typeAttr === 'meta') {
                        if (keyAttr === 'pageTitle') document.title = row['Data 1'];
                        if (keyAttr === 'pageHeader') document.getElementById('dynamic-title').innerText = row['Data 1'];
                        if (keyAttr === 'showBackBtn') {
                            document.getElementById('back-button').style.display = (row['Data 1'].toString().toUpperCase() === 'TRUE') ? 'block' : 'none';
                        }
                        return;
                    }

                    if (typeAttr === 'text') {
                        const p = document.createElement('p');
                        p.className = 'intro-text-block';
                        p.innerText = contentText;
                        dynamicContent.appendChild(p);
                        return;
                    }
                    if (typeAttr === 'image') {
                        const img = document.createElement('img');
                        img.src = row['Data 1'];
                        img.className = 'content-image-centered';
                        dynamicContent.appendChild(img);
                        return;
                    }
                });

                let filteredData = data.filter(item => item.Type === 'row' || item.Type === 'data');
                loadingIndicator.style.display = 'none';

                if (filteredData.length > 0) {
                    document.getElementById('pagination').style.display = 'flex';
                    if (type === 'table') {
                        document.getElementById('table-view').style.display = 'block';
                        renderTableHeaders();
                        engine.init(filteredData, table_Config);
                    } else {
                        document.getElementById('cloze-view').style.display = 'block';
                        clozeEngine.init(filteredData);
                    }
                }
            } catch (err) {
                loadingIndicator.innerHTML = `<span style="color:red"><b>Handshake Failed:</b> ${err.message}</span>`;
            }
        }

        function renderTableHeaders() {
            const headerRow = document.getElementById('table-headers');
            const labels = ["Artikel", "Singular (Ob)", "Singular (Be)", "Plural (Ob)", "Plural (Be)", "Grupp", "Kontroll", "Ã–versÃ¤ttning"];
            headerRow.innerHTML = labels.map(l => `<th>${l}</th>`).join('');
        }

        window.onclick = function(event) {
            if (!event.target.matches('.lang-selected-btn') && !event.target.closest('.lang-selected-btn')) {
                const dropdown = document.getElementById('lang-dropdown');
                if (dropdown && dropdown.classList.contains('show')) dropdown.classList.remove('show');
            }
        }

        document.addEventListener('DOMContentLoaded', initMasterApp);
    </script>
</body>
</html>