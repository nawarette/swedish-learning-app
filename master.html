<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Svenska Ã–vning - Master Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="global/style/style.css?v=1">
    <link rel="icon" type="image/x-icon" href="global/style/favicon/favicon.ico">
</head>
<body>
    <header class="main-header">
        <h1>
            <a href="index.html" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 10px;">
                <img src="global/style/images/NK_Avatar.png" alt="Logo" class="header-logo"> Grammatik Portal ğŸ‡¸ğŸ‡ª
            </a>
        </h1>
        <div class="lang-selector-container">
            <button class="lang-selected-btn" onclick="toggleLangDropdown()">
                <span id="current-flag">ğŸ‡¸ğŸ‡ª</span> <span id="current-lang-code">SV</span>
            </button>
            <ul id="lang-dropdown" class="lang-dropdown">
                <li onclick="changeLanguage('sv', 'ğŸ‡¸ğŸ‡ª')">ğŸ‡¸ğŸ‡ª SV (Svenska)</li>
                <li onclick="changeLanguage('en', 'ğŸ‡¬ğŸ‡§')">ğŸ‡¬ğŸ‡§ EN (English)</li>
                <li onclick="changeLanguage('th', 'ğŸ‡¹ğŸ‡­')">ğŸ‡¹ğŸ‡­ TH (à¹„à¸—à¸¢)</li>
            </ul>
        </div>
    </header>

    <div class="layout">
        <nav class="sidebar"><ul id="shared-sidebar"></ul></nav>
        <main class="content">
            <section class="practice-area">
                <div class="section-header">
                    <h2 id="dynamic-title">Laddar...</h2>
                    <a id="back-button" href="javascript:void(0);" onclick="history.back()" class="back-btn" style="display:none;">â¬… Tillbaka</a>
                </div>
                <div id="loading-indicator" style="text-align: center; padding: 50px;">Laddar portalen...</div>
                <div id="dynamic-content"></div>
                
                <div id="table-view" style="display: none;">
                    <div class="top-controls">
                        <div class="left-actions">
                            <button id="restart-btn" onclick="engine.clearAll()">ğŸ”„ Starta om / Slumpa</button>
                            <div id="selection-tools" style="display:none;"></div>
                        </div>
                        <div class="right-actions">
                            <button id="filter-btn" onclick="engine.enterSelectionMode()">âš™ï¸ Setting</button>
                            <div class="filter-controls">
                                <button id="save-filter-btn" onclick="engine.saveSelection()" style="display:none;">Spara</button>
                                <button id="cancel-filter-btn" onclick="location.reload()" style="display:none; margin-left:5px;">Avbryt</button>
                            </div>
                        </div>
                    </div>
                    <table class="practice-table">
                        <thead><tr id="table-headers"></tr></thead>
                        <tbody id="practice-rows"></tbody>
                    </table>
                </div>

                <div id="cloze-view" style="display: none;"><div id="exercise-container" class="exercise-container"></div></div>
                
                <div id="pagination" class="controls" style="display: none; gap: 10px; margin-top: 20px;">
                    <button id="prev-set-btn" onclick="engine.loadPreviousSet()">â¬… FÃ¶regÃ¥ende</button>
                    <button id="next-set-btn" onclick="engine.loadNextSet()">NÃ¤sta</button>
                </div>
            </section>
        </main>
    </div>

    <script src="global/engine/table_engine.js"></script>
    <script src="global/engine/cloze_engine.js"></script>
    <script src="global/engine/dashboard_engine.js"></script>

    <script>
        const _idMap = {
            'other': 'AKfycbxXh_MXiFgt695vfhAHkbMMIbM4wdPI9jF1mmtH2u1JvJbmRVK1fCUk7DuMkjhscjNJ',
            'gmmr':  'AKfycbyZX7QwLBnnWointK_Fdu61mBDxJrrasK3TLGnc36kp4UiXU13gie3fRcrObcKhOlemtA',
            'gmmr_noun': 'AKfycbzm6GAn883Y-yLwr63p3XjdUAspw3OM4BkV71rRKGUy0KagSC_pY378_Df7XmliTiPt',
            'dict':  'AKfycb_YOUR_DICTATION_ID_HERE'
        };

        const table_Config = { primaryKey: 'Data 3', columns: [] };

        function toggleLangDropdown() { document.getElementById('lang-dropdown').classList.toggle('show'); }
        function changeLanguage(c, f) { localStorage.setItem('userPreferredLang', c); localStorage.setItem('userPreferredFlag', f); location.reload(); }
        function initLanguageUI() { const l = localStorage.getItem('userPreferredLang') || 'sv'; document.getElementById('current-lang-code').innerText = l.toUpperCase(); document.getElementById('current-flag').innerText = localStorage.getItem('userPreferredFlag') || 'ğŸ‡¸ğŸ‡ª'; }
        
        async function loadSidebar() {
            const r = await fetch('global/sidebar.html');
            const container = document.getElementById('shared-sidebar');
            container.innerHTML = await r.text();
            const p = new URLSearchParams(window.location.search);
            const cat = p.get('category')?.replace(/(_0_0|_0)$/, "");
            if (cat) {
                const activeLink = container.querySelector(`[data-nav="${cat}"]`);
                if (activeLink) activeLink.classList.add('active');
            }
        }

        async function initMasterApp() {
            initLanguageUI(); await loadSidebar();
            const p = new URLSearchParams(window.location.search);
            const userTheme = p.get('theme')?.toLowerCase() || 'all'; 
            const userLevel = p.get('level')?.toLowerCase(); 
            let cat = p.get('category') || 'other_index';
            
            const cleanCat = cat.replace(/(_0_0|_0)$/, ""); 
            const pref = cleanCat.split('_')[0];

            let type = p.get('type');
            if (!type && userLevel && pref === 'gmmr') type = 'table';
            if (!type) type = 'dashboard';

            const targetId = (userLevel && _idMap[cleanCat]) ? _idMap[cleanCat] : (_idMap[pref] || _idMap['other']);
            const ACTIVE_DB_URL = `https://script.google.com/macros/s/${targetId}/exec`;
            
            let sheetName = cleanCat;
            if (pref === 'gmmr' || pref === 'dict') {
                sheetName = userLevel ? `${cleanCat}_${userLevel}_0` : `${cleanCat}_0_0`;
            }

            try {
                const res = await fetch(`${ACTIVE_DB_URL}?sheet=${sheetName}`);
                const rawData = await res.json();
                if (!Array.isArray(rawData)) throw new Error(`Flik ej hittad: ${sheetName}`);

                document.getElementById('loading-indicator').style.display = 'none';
                const container = document.getElementById('dynamic-content');
                container.innerHTML = '';
                const lang = localStorage.getItem('userPreferredLang') || 'sv';

                let data = rawData.filter(row => {
                    const rowType = row.Type?.toLowerCase().trim();
                    if (rowType === 'row' || rowType === 'data') {
                        const rowTheme = row['Data 1']?.toLowerCase().trim() || "";
                        if (userTheme === 'all') return true;
                        return (rowTheme === userTheme);
                    }
                    return true; 
                });

                let dashboardRows = [];
                let collectingDash = false;
                let lastDashLogic = 'grid-smart';

                data.forEach(row => {
                    const typeAttr = row.Type ? row.Type.toLowerCase().trim() : '';
                    
                    if (typeAttr === 'meta') {
                        const key = row['Content/Key'];
                        const logicVal = row.Logic ? row.Logic.toString().toLowerCase().trim() : "";
                        
                        // --- UPDATED DYNAMIC PAGE HEADER LOGIC (USING #) ---
                        if (key === 'pageHeader') {
                            const headerText = row['Data 1'];
                            
                            // 1. Priority Match: Theme in Logic column matches userTheme
                            if (userTheme !== 'all' && logicVal === userTheme) {
                                document.getElementById('dynamic-title').innerText = headerText;
                                document.getElementById('dynamic-title').dataset.matched = "true";
                            } 
                            // 2. Fallback Match: logicVal is '#' AND no specific match found yet
                            else if (logicVal === "#" && !document.getElementById('dynamic-title').dataset.matched) {
                                document.getElementById('dynamic-title').innerText = headerText;
                            }
                        }

                        if (key === 'pageTitle') {
                            document.title = row['Data 1'] || row.Logic;
                        }

                        if (key === 'showBackBtn') {
                           const show = (row['Data 1'] || row.Logic)?.toString().toUpperCase() === 'TRUE';
                           document.getElementById('back-button').style.display = show ? 'block' : 'none';
                        }
                        return;
                    }

                    if (typeAttr === 'dashboard' || typeAttr === 'dashboard_start') {
                        collectingDash = true; dashboardRows = []; lastDashLogic = row.Logic || 'grid-smart'; return;
                    }
                    if (collectingDash && typeAttr === 'card') {
                        dashboardRows.push(row); return;
                    }
                    if (typeAttr === 'dashboard_end' && collectingDash) {
                        collectingDash = false;
                        renderDash(); return;
                    }

                    if (typeAttr === 'text') {
                        const col = lang === 'en' ? 'Data 2' : (lang === 'th' ? 'Data 3' : 'Data 1');
                        const pTag = document.createElement('p'); pTag.className = 'intro-text-block'; 
                        pTag.innerText = row[col] || row['Data 1']; container.appendChild(pTag);
                    } else if (typeAttr === 'image' && row['Data 1']) {
                        const img = document.createElement('img'); img.src = row['Data 1']; 
                        img.className = 'content-image-centered'; container.appendChild(img);
                    }
                });

                if (collectingDash && dashboardRows.length > 0) renderDash();

                function renderDash() {
                    const dId = `dash-${Math.random().toString(36).substr(2, 9)}`;
                    const dDiv = document.createElement('div'); dDiv.id = dId;
                    container.appendChild(dDiv);
                    dashboardEngine.init(dId, dashboardRows, lastDashLogic);
                }

                const exercises = data.filter(i => i.Type?.toLowerCase() === 'row' || i.Type?.toLowerCase() === 'data');
                if (exercises.length > 0) {
                    document.getElementById('pagination').style.display = 'flex';
                    if (type === 'table') { 
                        document.getElementById('table-view').style.display = 'block'; 
                        renderTableHeaders(); engine.init(exercises, table_Config); 
                    } else { 
                        document.getElementById('cloze-view').style.display = 'block'; clozeEngine.init(exercises); 
                    }
                }
            } catch (err) { document.getElementById('loading-indicator').innerHTML = `<span style="color:red">Error: ${err.message}</span>`; }
        }

        function renderTableHeaders() { 
            const h = document.getElementById('table-headers'); 
            const l = ["Artikel", "Singular (Ob)", "Singular (Be)", "Plural (Ob)", "Plural (Be)", "Grupp", "Kontroll", "Ã–versÃ¤ttning"]; 
            h.innerHTML = l.map(x => `<th>${x}</th>`).join(''); 
        }
        window.onclick = (e) => { if (!e.target.closest('.lang-selected-btn')) document.getElementById('lang-dropdown').classList.remove('show'); };
        document.addEventListener('DOMContentLoaded', initMasterApp);
    </script>
</body>
</html>